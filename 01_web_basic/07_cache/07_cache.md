# 1：キャッシュはなぜ必要なのか

キャッシュはデータの二回目の表示の際に高速化させる効果があります。<br>
「以前すでに取得したデータ」の中でも使用頻度が高いものを、高速アクセスができる箇所、例えばweb表示においてはブラウザや、<br>
プログラムにおいてはリストなどに保管しておくことができ、二回目以降の該当データのアクセスの際に参照し、取得や表示の処理を高速化することができます。<br>
この機能がないとデータの表示、処理の際に毎回データの生成や取得を行い、その都度同じだけの時間がかかってしまいます。<br>


# 2:キャッシュの種類
・ブラウザキャッシュ<br>
一度アクセスしたサイトの画像やhtmlデータなどをブラウザに保管し、次回同じページを閲覧する際に、そのキャッシュを参照することでネットから読み込むより高速にサイトを表示できる。<br>

・webキャッシュサーバー
サーバーが配信するページや画像を複製、保持し、リクエストがあるとサーバーに変わりこれらのデータを提供する。（これにより通信料を抑え提供できる）<br>
複数のキャッシュサーバーをロードバランサーを使い振り分けるなどの運用方法がある。
またCDNサービスにおいても、さまざまな場所からの多くのアクセスに耐えるよう、このキャッシュサーバーを利用するケースがある。

・プログラムにおけるキャッシュ例
2重のfor文を実施する場合に、あらかじめ参照用の配列を作っておく。2重目のforでは全てをループするのではなく、参照用の配列を参照し、計算量を抑える方式。<br>
参考例：https://qiita.com/naokikobashi/items/cb9323e57d6b5f2c7130

# 3:キャッシュを制御するヘッダー
## Cache-Control
キャッシュの有効期限を秒数で指定します。さまざまなパラメータがあります。
Cache-Control "no-store"<br>
webサーバーから返されるコンテンツをキャッシュをしない設定。アクセスするごとに内容が変わるようなコンテンツの場合に使います。<br>

Cache-Control "no-cache"<br>
（no-storeと似ているが意味が異なります。）一度キャッシュに記録されたデータについては、現在も有効かどうかをサーバに問い合わせ、<br>
確認が取れない場合はそのキャッシュは利用しない。

Cache-Control: must-revalidate<br>
キャッシュデータが現在も有効かどうか、必ずサーバーに問い合わせる。<br>

Cache-Control "max-age=秒数" 例：86400など（この場合は1日）<br>
ブラウザに指定の秒数キャッシュさせます。

cache-control: private<br>
クライアント（ブラウザ）のみがキャッシュできるようにする

cache-control: public<br>
どのキャッシュにも格納できる設定。

## Expires
キャッシュの有効期限を日時で指定します。<br>
Cache-Controlの max-age と両方記載がある場合は、Cache-Control の設定が優先されます。

## Last-Modified
リソースの最終更新日を表します。
ブラウザがキャッシュしているファイルの最終更新日をサーバーに知らせ、サーバー側の最終更新日と一致していればキャッシュを使い、そうでなければ改めてファイルをダウンロードします。
E-tagより精度が低いです。

## ETag
各リソースに付与される識別子です。Last-Modifiedと同様にブラウザのキャッシュの有効性を識別子で判定します。<br>
Last-Modifiedより精度は高く、Last-Modified と ETag の両方がある場合は、ETag の検証結果が優先されます。

# 4:キャッシュサイズについて
容量の上限を超えると、参照すべきデータを大量に保持していることで、毎回表示しようとしているサイトに一致するデータを見つけようとするため、<br>
表示挙動が重くなる傾向があります。<br>

# 5:動的なページにおけるキャッシュのexpiresについて
ユーザーの情報が定期的に更新される可能性があるような動的ページの場合、期限を設定してキャッシュを保持するようにしてしまうと、不正確な情報がページに表示される可能性があります。<br>
例えばユーザーの保有ポイントなどが画面に表示されており、そのポイントを使うとリアルタイムで画面上の数値も変動する場合。<br>
期限が切れるタイミング、ユーザーがアクセスするタイミング、ユーザーがポイントを追加したり消費するタイミングが異なるため、キャッシュを残したままでは、変更前のポイント数が画面に残ってしまいます。
<br>
常に動的に表示が変わる可能性があるようなページの場合、キャッシュ自体を残さないように、Cache-Control "no-store"をすべきです。

# 6_1 ブラウザのキャッシュがWEBサービスに用いられている仕組み

サイトにアクセスするとまずはリソースをダウンロードし、ブラウザはダウンロードしたデータをキャッシュに保管します。<br>
2回目以降のアクセスでは、<br>
・キャッシュが有効期限内か<br>
・サーバーのリソースデータに更新はないか<br>
どちらかに当てはまった場合は、ブラウザはキャッシュを再利用します。<br>そうでなければ、再度ダウンロードをします。

# 6_2 その実例
## [◼️mozillaのキャッシュの説明ページ](./キャッシュ1.png)
https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Cache-Control

## [◼️キャッシュについて説明しているページ](./キャッシュ2.png)
https://webtan.impress.co.jp/g/%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5

## [◼️任天堂ホームページの画像](./キャッシュ3.png)
https://www.nintendo.co.jp/top/img/switch_marioGolf_thumb.jpg
<br>なお、ページそのもの(https://www.nintendo.co.jp)はキャッシュの設定はされていません。画像のみの指定でした。


## [使われていないケース例](./noキャッシュ.png)
https://www.amazon.co.jp/


# キャッシュを返すサーバー作成

index.jsで記述。
エンドポイント「'/'」でキャッシュありのページ表示。
エンドポイント「'/no_cache」で文字通りキャッシュなしのページを表示。

結果は以下

[キャッシュあり](./result/use_cache.png)
[キャッシュなし](./result/no_cache.png)


