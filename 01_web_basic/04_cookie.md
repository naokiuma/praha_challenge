# 課題1

## 1

クッキーとは、webサービス側（サーバー）がブラウザに対してもたせる情報です。
この値はブラウザに保管され、次にそのブラウザがサーバーにアクセスした際に、
サーバーが、「このクッキー情報を持っているということは以前アクセスした人だな」と認識するのに使われます。
<br><br>
現実に例えると病院の受付番号の記載された券のようなもので、
最初に病院の受付に患者が訪問した際、患者の名前や症状などを病院側で受け取り、病院は患者に受付番号を配ります。
例えば<br>
受付番号1　名前　山田太郎さん　症状　風邪<br>
受付番号2　名前　ケビンさん　症状　頭痛<br>
だった場合、病院側は受付番号のみで患者の名前、症状が分かります。
### この受付番号がクッキーとなります。

この仕組みがあることで、それぞれの患者さんの診察の順番が来たときに改めて名前や症状を聞く必要がなくなります。
患者側も改めて伝える必要はありません。<br><br>

webにおいては、サーバー側では<br>
1.httpレスポンスのヘッダをつかい、「名前=値」の組み合わせでブラウザにセットします。<br>
2.ブラウザはそのサーバーにアクセスするたびにクッキーを送信します。<br>
前述の病院で表すと、1が「病院が診察券を渡すこと」、2が「患者が診察券を返すこと」になります。<br>
<br>
この1の処理、サーバーからブラウザにクッキーを渡すことができる処理をsetcookieと言います。
setcookieの情報ではそのクッキーをどれくらい残すかといった有効期限、特定のドメインやパスへの追加の制約を設定し、クッキーの送信先の設定を変更することができます。
<br><br>
また、クッキーの仕組みを使い、セッション情報を保持させることで、<br>
・ログインできるサイトで一度ログインしたら毎回ログインをすることをスキップしたり<br>
・ショッピングサイトなどでどのアイテムをカートに入れたのか？などの情報を保持するなど、<br>
webサイトのサービスの向上に役立てることができます。<br>
これらの仕組みがないと、httpの仕組み上、異なるページに遷移したときにこの履歴が残りません（これをステートレスと言います。クッキーを利用することでステートフルにすることができます。）
<br><br>
なお、クッキーはブラウザごとに渡すため、Aサイトにfirefoxにアクセスし、ログイン情報を保持しているpcでも、
GoogleChromeで同じAサイトにアクセスしてもログイン情報は保持されていません。<br>
改めてChromeでもログインを実施した情報をクッキーに残すといった流れが必要になります。
<br>
<br>

## 2
基本的には近年は送信されなくなってきています。<br><br>
URLが違う = 異なるサイトとなりますが異なるサイトにブラウザからクッキー送信できてしまうと、意図しない情報がほかのWebサーバーに送られてしまいます。<br>
※A病院の診察受付券を持ってB病院に行くようなもの。<br>
これは異なるサイト間での予期しないCSRF攻撃への脆弱性が発生する原因となります。


## 3
はい、同じサーバーであればポート番号が違っても送信可能です。<br>
ポート番号が異なる場合でも、サーバーが同じであればクッキーの送信が行えます。<br>


## 4
この例のようにドメイン自体が異なる場合、クッキーの送信は行えません。<br>
www と　www.api <br>
と、サブドメインが異なる状態の場合でも、domain属性を設定すれば、サブドメインが異なるドメイン間での送信が可能です。<br>
ドメイン属性を指定することでサブドメイン間でクッキーを送ることができるようになります。<br>
例えば Domain=hoge.com を設定すると、test.hoge.comに送ることが可能です。<br>
※設定していなければこの送信はできません。

## 5

クッキー設定時にHttpOnly属性を指定することで可能です。<br>
例えば、サーバー側のセッションを持続させるクッキーなど、jsの操作が不要なクッキーにおいては、この設定をすることが推奨されています。

## 6

Secure属性をクッキーに設定することで可能です。<br>
なおexpressにおいては下記の指定でsecureや、前述のhttpOnlyの属性指定が可能です。<br>

```javascript 
app.use(session({
  name: 'session',
  keys: ['key1', 'key2'],
  cookie: {
    secure: true,
    httpOnly: true,
    domain: 'example.com',
    path: 'foo/bar',
    expires: expiryDate
  }
```

## 7
クッキーを所持する持続時間が指定されます。<br>
例として、24時間後と指定すれば、文字通り24時間後にクッキーの所有が破棄されるため、
そのブラウザがもし「サービスへのログイン」をクッキー情報で行っていた場合はログアウトされます。<br>
なお、持続時間はサーバーではなく「Cookie が設定されるクライアントの日時」をもとに持続時間が計算されます。

## 8
SameSiteの属性をクッキー設定時に指定することで異なるオリジン間のクッキーの送信のセキュリティを強化、または緩くすることができます。
SameSte属性は、今開いているページのドメインから、別のドメインにリクエストを送る際に、クッキーをセットするかどうかの仕組みのレベルを指定できるものです。
<br>
SameSiteの属性にはStrict, Lax, Noneの３種があります。<br>
Strinctは厳しく、クッキーを発行したサーバーへのみ送信が可能です。Laxは、ユーザーがリンクをたどるなど、外部のサイトからURL に移動した場合は送信するなど、少し制限がゆるい状態です。
None はサイト間リクエストの制限はありません。
<br>

厳しいほどセキュリティレベルは高く、CSRFに備えることができ、また近年はこのセキュリティレベルが全体的に高まっています。<br>
※以前はGoogle Chromeではデフォルトでnoneだったのが、chrome 80 以降はlaxになった、という経緯があります。

<br>
なお、上記のChromeの仕様変更は一時的にロールバックされ、84でまたデフォルトでlaxになったという背景もあったりします。<br>
※コロナの影響でよりwebを使う人が増えてきている中、対応が少し大変なため規制が緩和されたようなイメージです。
<br>
参考<br>
https://help.salesforce.com/articleView?id=000351874&language=ja&mode=1&type=1
https://japan.cnet.com/article/35151911/


## 9
通信の際に取得される可能性がある要素と考え、基本的には個人を特定できる情報、権限を付与するような情報は入れないようにします。名前、電話番号、メールアドレス、またアクセス権限を持つアカウントの情報など。


## 10

クッキーとローカルストレージの違いとして、<br>
・クッキーは通信のたびに毎回送信が実施されます。<br>
・ローカルストレージは利用する場合のみ通信されます。<br>

そのため、「ログインするwebサービスにおいて、全ページでログインの有無を判定するセッション情報」など、サーバー側で毎回必要とする情報に関連するデータをクッキーに保管すると良いと思われます。<br>
また、ローカルストレージはサーバーに保管する必要がない情報を設定します。<br>
例として多言語サイトの選択言語状況や、ダークモードなどなど。
※選択言語をあえてサーバーに送り統計に使いたい場合は選択の余地はあるかと思われます。

## 11

脆弱性のある掲示板Aの投稿フォームがあったとします。<br>
また、そのAに似せた掲示板Bの投稿フォームを作ったとします。<br><br>

まず、ハッカーがなんらかの方法で罠のサイトCへ他のユーザーを誘導します。<br>
その罠サイトにユーザーがアクセスし、リンククリックなどなんらかの操作をすると、スクリプトが実行されます。<br>
そのままAサイトにアクセスすると、スクリプトにより偽サイトであるBにアクセスさせられます。（クロスサイト）<br>
※ここではBのなかでiframでAを表示させる、そのままAに似たサイトを用意するなどの方法があります。<br>
<br>
この状態で、ユーザーのクッキー情報をメールで送信するなどして取得することができます。
<br><br>
対策としては、「スクリプトが実行される」ことを防ぐ必要があり、そのためには閲覧者が入力できる全ての箇所でのセキュリティを高める必要があります。
サービス側で取れる対策としては「入力できる情報を制限する」「エスケープ処理」などが挙げられます。<br>
<br>

## クイズ
クッキーの属性の一つSamesite属性は、最近のChromeではデフォルトで「none」から「lax（少しきびしい）」に切り替わりました。<br>
ただ、laxの場合この場合異なるドメインのサイトを経由してもクッキーを保持できません。<br>
例としてECサイトを作り、決済関連は外部の決済サービスを使っている場合に、<br>
<br>
・webサイトで商品を確認→そのサイトからのリンクでカートに入れる（外部サイト）をし、購入→購入後webサイトに戻る、など。
<br>
<br>
laxやstrictなどの場合、この外部サイトを経由したことでクッキーが外れるケースがあります。
あえてnoneにしたい場合、samesite属性以外に必要な設定（指定すべき情報）があります。それはなんでしょうか？
<br>
