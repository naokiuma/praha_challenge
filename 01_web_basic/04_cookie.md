# 課題1

## ・クッキーとは何でしょうか？「Set-cookie」「ヘッダ」「サーバ」「ブラウザ」という単語を使って、クッキーの仕組みを説明してみてください

クッキーとは、webサービス側（サーバー）がブラウザに対してもたせる情報です。
この値はブラウザに保管され、次にそのブラウザがサーバーにアクセスした際に、
サーバーが、「このクッキー情報を持っているということは以前アクセスした人だな」と認識するのに使われます。
<br><br>
現実に例えると病院の受付番号の記載された券のようなもので、
最初に病院の受付に患者が訪問した際、患者の名前や症状などを病院側で受け取り、病院は患者に受付番号を配ります。
例えば
受付番号1　名前　山田太郎さん　症状　風邪
受付番号2　名前　ケビンさん　症状　頭痛
だった場合、病院側は受付番号のみで患者の名前、症状が分かります。
### この受付番号がクッキーとなります。

この仕組みがあることで、それぞれの患者さんの診察の順番が来たときに改めて名前や症状を聞く必要がなくなります。
患者側も改めて伝える必要はありません。<br><br>

webにおいては、サーバー側では
1.httpレスポンスのヘッダをつかい、「名前=値」の組み合わせでブラウザにセットします。
2.ブラウザはそのサーバーにアクセスするたびにクッキーを送信します。
前述の病院で表すと、1が「病院が診察券を渡すこと」、2が「患者が診察券を返すこと」になります。

この1の処理、サーバーからブラウザにクッキーを渡すことができる処理をsetcookieと言います。
setcookieの情報ではそのクッキーをどれくらい残すかといった有効期限、特定のドメインやパスへの追加の制約を設定し、クッキーの送信先の設定を変更することができます。
<br><br>
また、クッキーの仕組みを使い、セッション情報を保持させることで、<br>
・ログインできるサイトで一度ログインしたら毎回ログインをすることをスキップしたり<br>
・ショッピングサイトなどでどのアイテムをカートに入れたのか？などの情報を保持するなど、<br>
webサイトのサービスの向上に役立てることができます。
これらの仕組みがないと、httpの仕組み上、異なるページに遷移したときにこの履歴が残りません（これをステートレスと言います。クッキーを利用することでステートフルにすることができます。）
<br><br>
なお、クッキーはブラウザごとに渡すため、Aサイトにfirefoxにアクセスし、ログイン情報を保持しているpcでも、
GoogleChromeで同じAサイトにアクセスしてもログイン情報は保持されていません。
改めてChromeでもログインを実施した情報をクッキーに残すといった流れが必要になります。




## ・www.hoge.comで発行されたクッキーは、www.fuga.comにも送信されるでしょうか？その理由を説明してください
基本的には近年は送信されなくなってきています。<br><br>
URLが違う = 異なるサイトとなりますが異なるサイトにブラウザからクッキー送信できてしまうと、意図しない情報がほかのWebサーバーに送られることを防ぎます。<br>
※A病院の診察受付券を持ってB病院に行くようなもの。<br>
これは異なるサイト間での予期しないCSRF攻撃への脆弱性が発生する原因となります。
<br><br>
なお、setcookieの際に

### domain属性
を指定することでサブドメイン間でクッキーを送ることができるようになります。
例えば Domain=hoge.com をせってすると、test.hoge.comに送ることが可能です。
※設定していなければこの送信はできません。
<br><br>
さらに、
## SameSiteの属性
を指定することで異なるオリジン間のクッキーの送信のセキュリティを強化、または緩くすることができます。
SameSte属性は、今開いているページのドメインから、別のドメインにリクエストを送る際に、クッキーをセットするかどうかの仕組みのレベルを指定できるものです。
<br>
SameSiteの属性にはStrict, Lax, Noneの３種があります。
Strinctは厳しく、クッキーを発行したサーバーへのみ送信が可能です。Laxは、ユーザーがリンクをたどるなど、外部のサイトからURL に移動した場合は送信するなど、少し制限がゆるい状態です。
None はサイト間リクエストの制限はありません。
<br>

厳しいほどセキュリティレベルは高くCSRFに備えることができ、また近年はこのセキュリティレベルが高まっています。
※以前はGoogle Chromeではデフォルトでnoneだったのが、chrome 80 以降はlaxになった、という経緯があります。
あえてnoneにしたい場合は、ssl化されているサイト間でのみクッキー送信ができる
### secure属性
の指定も必要となります。
<br><br>

なお、上記のChromeの仕様変更は一時的にロールバックされ、84でまたデフォルトでlaxになったという背景もあったりします。
※コロナの影響でよりwebを使う人が増えてきている中、対応が少し大変なため規制が緩和されたようなイメージです。
<br>
参考
https://help.salesforce.com/articleView?id=000351874&language=ja&mode=1&type=1
https://japan.cnet.com/article/35151911/






### ・hoge.com:8080のクッキーはhoge.com:9090にも送信されるでしょうか？
はい、同じサーバーであれば送信可能です。<br>
ポート番号が異なる場合でも、サーバーが同じであればクッキーの送信が行えます。<br>


### ・www.hoge.comで発行されたクッキーは、www.api.hoge.comにも送信されるでしょうか？
この例のようにドメイン自体が異なる場合、クッキーの送信は行えません。<br>



例えばショッピングサイト→決済の時だけ異なる専用ページへ遷移→戻ったときにログインが外れる？？
<br>
https://developer.mozilla.org/ja/docs/Web/HTTP/Cookies
<br>
https://www.ecbeing.net/contents/detail/235
<br>
いくら経由しても、送信先は同じなので外れないのでは。。？<br>
noneはサイト間リクエストの制限はなく
<br>
https://laboradian.com/same-site-cookies/
<br>
これが分かりやすい<br>
Strict では、クッキーはそれが発生したものと同じサイトに対してのみ送信されます。 Lax も似ていますが、ユーザーがリンクをたどるなど、外部のサイトからある URL に移動した場合は除きます。 None はサイト間リクエストの制限はありません。
